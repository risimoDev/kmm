{
  "name": "04 ‚Äî –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∫–∞—Ä—Ç–æ—á–µ–∫ —Ç–æ–≤–∞—Ä–∞",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "product-card",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "wh-card",
      "name": "üì• Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [200, 400],
      "webhookId": "product-card"
    },
    {
      "parameters": {
        "jsCode": "const input = $input.first().json;\nconst body = input.body || input;\n\nconst product_name = body.product_name;\nconst image_url = body.image_url;\nconst marketplace = body.marketplace || 'WB';\n\nif (!product_name) throw new Error('product_name is required');\nif (!image_url) throw new Error('image_url is required');\n\nreturn [{ json: {\n  product_name: product_name,\n  image_url: image_url,\n  marketplace: marketplace,\n  artikuls: body.artikuls || [],\n  product_description: body.product_description || '',\n  target_audience: body.target_audience || '',\n  key_features: body.key_features || '',\n  style: body.style || 'modern',\n  color_scheme: body.color_scheme || 'auto',\n  include_price: body.include_price || false,\n  price: body.price || '',\n  include_badge: body.include_badge || false,\n  badge_text: body.badge_text || '',\n  extra_instructions: body.extra_instructions || '',\n  session_id: body.session_id || null,\n  callback_url: body.callback_url || ''\n}}];"
      },
      "id": "validate-card",
      "name": "üîç –í–∞–ª–∏–¥–∞—Ü–∏—è",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [440, 400]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={ \"success\": true, \"message\": \"Product card generation started\", \"product_name\": \"{{ $json.product_name }}\" }",
        "options": {}
      },
      "id": "respond-card",
      "name": "‚úÖ –û—Ç–≤–µ—Ç 200",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [680, 240]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT key, value FROM app_settings WHERE category IN ('ai', 'branding');",
        "options": {}
      },
      "id": "load-settings-card",
      "name": "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [680, 560],
      "credentials": {
        "postgres": {
          "id": "BXL7joPD69X9xNOu",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const settings = {};\nfor (const row of $input.all()) {\n  settings[row.json.key] = row.json.value;\n}\nconst params = $('üîç –í–∞–ª–∏–¥–∞—Ü–∏—è').first().json;\n\nconst systemPrompt = settings.ai_system_prompt || '–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –¥–∏–∑–∞–π–Ω–µ—Ä –∫–∞—Ä—Ç–æ—á–µ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤.';\nconst model = settings.ai_model || 'gpt-4o';\nconst baseUrl = settings.ai_base_url || 'https://gptunnel.ru/v1';\nconst authPrefix = settings.ai_auth_prefix || '';\n\nreturn [{ json: { ...params, systemPrompt, model, baseUrl, authPrefix } }];"
      },
      "id": "prepare-config-card",
      "name": "üîß –ö–æ–Ω—Ñ–∏–≥",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [940, 560]
    },
    {
      "parameters": {
        "jsCode": "const ctx = $input.first().json;\n\nconst userPrompt = `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –∏ —Å–æ–∑–¥–∞–π –ø–æ–¥—Ä–æ–±–Ω—ã–π JSON —Å –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞.\n\n–¢–æ–≤–∞—Ä: ${ctx.product_name}\n–ú–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å: ${ctx.marketplace}\n–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç –ø—Ä–æ–¥–∞–≤—Ü–∞: ${ctx.product_description || '–Ω–µ—Ç'}\n–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è: ${ctx.target_audience || '—à–∏—Ä–æ–∫–∞—è'}\n–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏: ${ctx.key_features || '–æ–ø—Ä–µ–¥–µ–ª–∏ –ø–æ —Ñ–æ—Ç–æ'}\n–°—Ç–∏–ª—å –¥–∏–∑–∞–π–Ω–∞: ${ctx.style}\n–¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞: ${ctx.color_scheme}\n–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏: ${ctx.extra_instructions || '–Ω–µ—Ç'}\n\n–ù–ê –û–°–ù–û–í–ï –§–û–¢–û –¢–û–í–ê–†–ê –æ–ø—Ä–µ–¥–µ–ª–∏:\n1. –ö–∞—Ç–µ–≥–æ—Ä–∏—é —Ç–æ–≤–∞—Ä–∞\n2. –û—Å–Ω–æ–≤–Ω—ã–µ –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (—Ü–≤–µ—Ç, —Ñ–æ—Ä–º–∞, –º–∞—Ç–µ—Ä–∏–∞–ª)\n3. –£–¢–ü (—É–Ω–∏–∫–∞–ª—å–Ω–æ–µ —Ç–æ—Ä–≥–æ–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ)\n4. –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã –¥–ª—è –ø–æ–∫—É–ø–∞—Ç–µ–ª—è\n\n–°–æ–∑–¥–∞–π –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ü–†–û–î–ê–Æ–©–ï–ô –∫–∞—Ä—Ç–æ—á–∫–∏. –û—Ç–≤–µ—Ç —Å—Ç—Ä–æ–≥–æ JSON:\n{\n  \"main_title\": \"–Ø—Ä–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ (3-5 —Å–ª–æ–≤, –ø—Ä–∏–≤–ª–µ–∫–∞—é—â–∏–π –≤–Ω–∏–º–∞–Ω–∏–µ)\",\n  \"subtitle\": \"–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∫–ª—é—á–µ–≤–æ–π –≤—ã–≥–æ–¥–æ–π\",\n  \"bullet_points\": [\"5-7 –∫–æ—Ä–æ—Ç–∫–∏—Ö –£–¢–ü/–ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤ —Å emoji\"],\n  \"cta_text\": \"–ü—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é\",\n  \"seo_title\": \"SEO-–∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏\",\n  \"seo_description\": \"SEO-–æ–ø–∏—Å–∞–Ω–∏–µ 150-200 —Å–∏–º–≤–æ–ª–æ–≤\",\n  \"search_keywords\": [\"10-15 –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞\"],\n  \"category_suggestion\": \"–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–µ\",\n  \"color_palette\": [\"#hex1\", \"#hex2\", \"#hex3\"],\n  \"visual_style_notes\": \"–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –≤–∏–∑—É–∞–ª—å–Ω–æ–º—É –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—é\",\n  \"rich_content_blocks\": [\n    {\n      \"type\": \"hero\",\n      \"heading\": \"–ì–ª–∞–≤–Ω—ã–π –±–ª–æ–∫ —Å –∫—Ä—É–ø–Ω—ã–º —Ñ–æ—Ç–æ\",\n      \"text\": \"–û–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è hero-–±–ª–æ–∫–∞\"\n    },\n    {\n      \"type\": \"features\",\n      \"heading\": \"–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞\",\n      \"items\": [\"–ü—É–Ω–∫—Ç 1\", \"–ü—É–Ω–∫—Ç 2\", \"–ü—É–Ω–∫—Ç 3\"]\n    },\n    {\n      \"type\": \"usage\",\n      \"heading\": \"–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å\",\n      \"steps\": [\"–®–∞–≥ 1\", \"–®–∞–≥ 2\", \"–®–∞–≥ 3\"]\n    },\n    {\n      \"type\": \"specs\",\n      \"heading\": \"–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏\",\n      \"items\": {\"–ú–∞—Ç–µ—Ä–∏–∞–ª\": \"–∑–Ω–∞—á–µ–Ω–∏–µ\", \"–†–∞–∑–º–µ—Ä\": \"–∑–Ω–∞—á–µ–Ω–∏–µ\"}\n    }\n  ],\n  \"infographic_prompts\": [\n    \"–ü—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–Ω—Ñ–æ–≥—Ä–∞—Ñ–∏–∫–∏ —Å–ª–∞–π–¥–∞ 1 (–¥–µ—Ç–∞–ª—å–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —á—Ç–æ –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å)\",\n    \"–ü—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–Ω—Ñ–æ–≥—Ä–∞—Ñ–∏–∫–∏ —Å–ª–∞–π–¥–∞ 2\",\n    \"–ü—Ä–æ–º–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–Ω—Ñ–æ–≥—Ä–∞—Ñ–∏–∫–∏ —Å–ª–∞–π–¥–∞ 3\"\n  ],\n  \"a_plus_content\": {\n    \"brand_story\": \"–ò—Å—Ç–æ—Ä–∏—è –±—Ä–µ–Ω–¥–∞ / –º–∏—Å—Å–∏—è (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)\",\n    \"comparison_table\": {\"columns\": [\"–ù–∞—à —Ç–æ–≤–∞—Ä\", \"–ê–Ω–∞–ª–æ–≥–∏\"], \"rows\": [[\"–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ 1\", \"–ù–µ—Ç\"]]}\n  }\n}`;\n\nconst messages = [\n  { role: 'system', content: ctx.systemPrompt },\n  {\n    role: 'user',\n    content: [\n      { type: 'text', text: userPrompt },\n      { type: 'image_url', image_url: { url: ctx.image_url, detail: 'high' } }\n    ]\n  }\n];\n\nconst requestBody = JSON.stringify({\n  model: ctx.model,\n  messages: messages,\n  max_tokens: 4000,\n  temperature: 0.7\n});\n\nconst url = ctx.baseUrl.replace(/\\/+$/, '') + '/chat/completions';\nconst authHeader = ctx.authPrefix ? ctx.authPrefix + $env.AI_API_KEY : $env.AI_API_KEY;\n\nreturn [{ json: { url, body: requestBody, authHeader, ...ctx } }];"
      },
      "id": "build-analysis-body",
      "name": "üèóÔ∏è –ó–∞–ø—Ä–æ—Å –∞–Ω–∞–ª–∏–∑–∞ —Ñ–æ—Ç–æ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1200, 560]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $json.url }}",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.body }}",
        "options": {
          "timeout": 120000
        }
      },
      "id": "call-ai-analysis",
      "name": "üß† AI –∞–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1460, 560],
      "credentials": {
        "httpHeaderAuth": {
          "id": "YTA7VkJwvfpfaJec",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first().json;\nconst prevCtx = $('üèóÔ∏è –ó–∞–ø—Ä–æ—Å –∞–Ω–∞–ª–∏–∑–∞ —Ñ–æ—Ç–æ').first().json;\n\nlet content = '';\ntry {\n  content = response.choices[0].message.content;\n} catch (e) {\n  throw new Error('AI –Ω–µ –≤–µ—Ä–Ω—É–ª –æ—Ç–≤–µ—Ç: ' + JSON.stringify(response));\n}\n\n// –ò–∑–≤–ª–µ—á—å JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞\nlet cardData;\ntry {\n  const jsonMatch = content.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) {\n    cardData = JSON.parse(jsonMatch[0]);\n  } else {\n    throw new Error('JSON –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –æ—Ç–≤–µ—Ç–µ');\n  }\n} catch (e) {\n  throw new Error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –∫–∞—Ä—Ç–æ—á–∫–∏: ' + e.message + ' | Raw: ' + content.substring(0, 500));\n}\n\nreturn [{ json: {\n  product_name: prevCtx.product_name,\n  image_url: prevCtx.image_url,\n  marketplace: prevCtx.marketplace,\n  artikuls: prevCtx.artikuls,\n  session_id: prevCtx.session_id,\n  callback_url: prevCtx.callback_url,\n  style: prevCtx.style,\n  color_scheme: prevCtx.color_scheme,\n  include_price: prevCtx.include_price,\n  price: prevCtx.price,\n  include_badge: prevCtx.include_badge,\n  badge_text: prevCtx.badge_text,\n  card_data: cardData,\n  raw_ai_response: content\n}}];"
      },
      "id": "parse-analysis",
      "name": "üìã –ü–∞—Ä—Å–∏–Ω–≥ –∞–Ω–∞–ª–∏–∑–∞",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1720, 560]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "=INSERT INTO product_cards (\n  product_name, image_url, marketplace, artikuls,\n  main_title, subtitle, bullet_points, cta_text,\n  seo_title, seo_description, search_keywords,\n  category_suggestion, color_palette, visual_style_notes,\n  rich_content_blocks, infographic_prompts, a_plus_content,\n  style, color_scheme, status\n) VALUES (\n  '{{ $json.product_name.split(\"'\").join(\"''\") }}',\n  '{{ $json.image_url.split(\"'\").join(\"''\") }}',\n  '{{ $json.marketplace }}',\n  '{{ JSON.stringify($json.artikuls).split(\"'\").join(\"''\") }}'::jsonb,\n  '{{ $json.card_data.main_title.split(\"'\").join(\"''\") }}',\n  '{{ ($json.card_data.subtitle || \"\").split(\"'\").join(\"''\") }}',\n  '{{ JSON.stringify($json.card_data.bullet_points || []).split(\"'\").join(\"''\") }}'::jsonb,\n  '{{ ($json.card_data.cta_text || \"\").split(\"'\").join(\"''\") }}',\n  '{{ ($json.card_data.seo_title || \"\").split(\"'\").join(\"''\") }}',\n  '{{ ($json.card_data.seo_description || \"\").split(\"'\").join(\"''\") }}',\n  '{{ JSON.stringify($json.card_data.search_keywords || []).split(\"'\").join(\"''\") }}'::jsonb,\n  '{{ ($json.card_data.category_suggestion || \"\").split(\"'\").join(\"''\") }}',\n  '{{ JSON.stringify($json.card_data.color_palette || []).split(\"'\").join(\"''\") }}'::jsonb,\n  '{{ ($json.card_data.visual_style_notes || \"\").split(\"'\").join(\"''\") }}',\n  '{{ JSON.stringify($json.card_data.rich_content_blocks || []).split(\"'\").join(\"''\") }}'::jsonb,\n  '{{ JSON.stringify($json.card_data.infographic_prompts || []).split(\"'\").join(\"''\") }}'::jsonb,\n  '{{ JSON.stringify($json.card_data.a_plus_content || {}).split(\"'\").join(\"''\") }}'::jsonb,\n  '{{ $json.style }}',\n  '{{ $json.color_scheme }}',\n  'generated'\n) RETURNING *;",
        "options": {}
      },
      "id": "save-card",
      "name": "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [1980, 560],
      "credentials": {
        "postgres": {
          "id": "BXL7joPD69X9xNOu",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://dashboard:3001/api/internal/card-ready",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"card_id\": {{ $json.id }},\n  \"product_name\": \"{{ $('üìã –ü–∞—Ä—Å–∏–Ω–≥ –∞–Ω–∞–ª–∏–∑–∞').first().json.product_name }}\",\n  \"status\": \"generated\"\n}",
        "options": { "timeout": 10000 }
      },
      "id": "callback-card",
      "name": "üì° Callback",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2240, 560],
      "credentials": {
        "httpHeaderAuth": {
          "id": "YTA7VkJwvfpfaJec",
          "name": "Header Auth account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "const saved = $('üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É').first().json;\nreturn [{ json: { success: true, card_id: saved.id, product_name: saved.product_name } }];"
      },
      "id": "final-output-card",
      "name": "üì§ –†–µ–∑—É–ª—å—Ç–∞—Ç",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2500, 560]
    }
  ],
  "connections": {
    "üì• Webhook": {
      "main": [
        [
          { "node": "üîç –í–∞–ª–∏–¥–∞—Ü–∏—è", "type": "main", "index": 0 },
          { "node": "‚úÖ –û—Ç–≤–µ—Ç 200", "type": "main", "index": 0 }
        ]
      ]
    },
    "üîç –í–∞–ª–∏–¥–∞—Ü–∏—è": {
      "main": [
        [
          { "node": "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏", "type": "main", "index": 0 }
        ]
      ]
    },
    "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏": {
      "main": [
        [
          { "node": "üîß –ö–æ–Ω—Ñ–∏–≥", "type": "main", "index": 0 }
        ]
      ]
    },
    "üîß –ö–æ–Ω—Ñ–∏–≥": {
      "main": [
        [
          { "node": "üèóÔ∏è –ó–∞–ø—Ä–æ—Å –∞–Ω–∞–ª–∏–∑–∞ —Ñ–æ—Ç–æ", "type": "main", "index": 0 }
        ]
      ]
    },
    "üèóÔ∏è –ó–∞–ø—Ä–æ—Å –∞–Ω–∞–ª–∏–∑–∞ —Ñ–æ—Ç–æ": {
      "main": [
        [
          { "node": "üß† AI –∞–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ", "type": "main", "index": 0 }
        ]
      ]
    },
    "üß† AI –∞–Ω–∞–ª–∏–∑ —Ñ–æ—Ç–æ": {
      "main": [
        [
          { "node": "üìã –ü–∞—Ä—Å–∏–Ω–≥ –∞–Ω–∞–ª–∏–∑–∞", "type": "main", "index": 0 }
        ]
      ]
    },
    "üìã –ü–∞—Ä—Å–∏–Ω–≥ –∞–Ω–∞–ª–∏–∑–∞": {
      "main": [
        [
          { "node": "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É", "type": "main", "index": 0 }
        ]
      ]
    },
    "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É": {
      "main": [
        [
          { "node": "üì° Callback", "type": "main", "index": 0 }
        ]
      ]
    },
    "üì° Callback": {
      "main": [
        [
          { "node": "üì§ –†–µ–∑—É–ª—å—Ç–∞—Ç", "type": "main", "index": 0 }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "tags": []
}
